\section{Virtualization}
Virtualization is an established architectural concept in computer science and
has been in use since decades. Operating systems for example provide virtual
address spaces to application processes, giving them the illusion of unlimited,
continuous memory. An application does not need to take care of complex memory
management tasks and the operating system is able to optimize the usage of
physical memory. Another common example is the virtualization of devices such as
virtual CD-ROM drives directly using a file-based backend for data I/O
\cite{CryptoCloud}.

Hardware or platform virtualization is the process of creating virtual computer
hardware that acts like real hardware. The virtualization is performed on the
host machine by special software, called a hypervisor\index{hypervisor} or
virtual machine monitor (VMM\index{VMM}). These two terms are synonyms, for
consistency we will use VMM throughout this document. VMMs are classified into
two types see figure \ref{fig:vmm-classification}.

\begin{figure}
	\centering
	\begin{subfigure}[b]{0.24\textwidth}
		\centering
		\input{graph_vmm_type1}
		\caption{\emph{Type I, native or bare metal VMM.} Runs directly on the
		hardware in the most privileged processor mode.}
	\end{subfigure}
	\qquad
	\begin{subfigure}[b]{0.24\textwidth}
		\centering
		\input{graph_vmm_type2}
		\caption{\emph{Type II or hosted VMM.} The VMM runs on top of a
		conventional operating system and uses OS services.}
	\end{subfigure}
	\caption{VMM classification}
	\label{fig:vmm-classification}
\end{figure}

Software that runs in a virtualized environment is called guest software. The
words host and guest are used to distinguish the software that runs on the
physical machine from the software that runs on the virtual machine
\cite{wiki:virtualization}.

By using virtualization and scheduling techniques, a VMM multiplexes the real
hardware of a computer making it possible to run multiple guests in
parallel\footnote{On multicore machines in parallel, on single-core machines
pseudo-parallel} on one machine. This is the most common use-case for
virtualization: The consolidation of operating system instances on one server to
save power and to improve hardware-resource utilization.

A guest program is separated from the real hardware of a machine, direct access
is restricted and can be controlled by the host VMM. Since the VMM has complete
control over the hardware of a system and all guest software, virtualization is
also useful for separation purposes. The VMM can allow certain communication
channels between guest software while restricting others. One guest could have
access to the network card, while others share a page in memory but have no
access to hardware devices.

The principle idea of virtualization is to run guest code in the virtual machine
and intercept privileged operations which access critical resources or system
properties. A guest traps into the VMM if such an instruction is executed and
the VMM acts according to the situation. This method is used to implement a
technique called "trap and emulate". For example if a guest accesses a device
which is emulated by the VMM, access to the virtual device causes a trap into
the VMM. The VMM itself or a special monitor VM then emulates the requested
operations of the guest software by directly modifying the state of the virtual
processor or memory of the guest VM.

\subsection{Intel Virtualization Technology (VT)}
A trap from the guest into the VMM is a costly operation. To reduce traps,
mechanisms in modern processors have been introduced to support the VMM in
creating a virtual machine environment. These features not only improve the
performance of a virtual machine by avoiding traps, but also allow the VMM code
to be much simpler.

Intel Virtualization Technology (VT\index{VT}) provides hardware-assisted
virtualization mechanisms for Intel processors. Intel VT encompasses multiple
virtualization features:
\begin{itemize}
	\item Intel VT-x
	\item Intel EPT
	\item Intel VT-d
\end{itemize}

\subsubsection{Intel VT-x}
Intel VT-x\index{VT-x} provides a virtual machine architecture to allow
efficient processor virtualization. An Intel processor reports this feature
with the Virtual Machine Extensions (VMX\index{VMX}) CPU flag.

The virtual machine architecture is implemented by a new form of processor
operation called VMX operation. This mode is enabled by executing the
\texttt{VMXON} instruction and, if successful, provides two operating modes:
VMX root operation and VMX non-root operation. Figure \ref{fig:vmm-lifecycle}
shows the life cycle of a VMM and the transitions between guest software and
VMM.

\begin{figure}[h]
	\centering
	\input{graph_vmm_lifecycle}
	\caption{Interaction of VMM and Guests}
	\label{fig:vmm-lifecycle}
\end{figure}

The VMX root operation mode is used for the VMM software while guest software
runs in VMX non-root operation mode. A transition from VMX root to VMX non-root
is called a VM entry, while a transition from VMX non-root to VMX root is
called a VM exit or trap.

Processor behavior in VMX root mode is very similar to non-VMX operation.  The
main difference is the extra instruction set provided by VMX, containing
virtualization-specific instructions used to manage VMX processor mode and
virtual machine control structures.

In VMX non-root operation however, the execution environment is restricted to
facilitate virtualization. Privileged or critical instructions cause VM exits
instead of their normal behavior. This allows the VMM to regain control of
processor resources if needed and, depending on the trapping instruction,
emulate certain functionality.

The VMM software initiates a VM entry into guest code by executing the
\texttt{VMLAUNCH} and \texttt{VMRESUME} instructions. Only one guest can be
active at any given time on one logical processor. The VMM regains control
using the VM exit mechanism.  If an exit occurs, the VMM analyzes the cause for
the exit and acts accordingly. It may resume the guest software or allocate
processor time to another guest. The VMM exits VMX operation by calling the
\texttt{VMXOFF} instruction.

The Virtual-Machine Control Structure (VMCS\index{VMCS}) is used to control VMX
non-root operation and VMX transitions. Each virtual machine has a VMCS
assigned which allows fine-grained setup of processor behavior in VMX non-root
mode.

For further information about the VMX processor extensions and VMCS, the reader
is directed to the respective chapter in the Intel Software Developer
Manual\index{Intel SDM} \cite{IntelSDM}, chapter 23.

\subsubsection{Intel EPT}
Extended Page Table (EPT\index{EPT}) is Intel's implementation of the Second
Level Address Translation (SLAT\index{SLAT}) virtualization technology. It
provides hardware-assisted translation of guest-physical memory addresses to
host physical addresses. Guest-physical addresses are translated by traversing a
set of EPT paging structures provided by the VMM to produce physical addresses
that are used to access memory \cite{IntelSDM}.

The EPT paging structure confines the host physical memory region one guest
virtual machine is allowed to access, making it possible to safely run
unmodified guest OS memory management code. Access to host physical memory
outside of the allowed region will result in an EPT violation trap.

Without EPT, the burden of translating guest-physical addresses to host physical
addresses while guaranteeing guest/vmm and guest/guest memory space separation
is on the VMM. This is a non-trivial task which is also inefficient. EPT removes
the complexity of manual memory address translations from the VMM, making the
code simpler while improving the virtualization speed.

\subsubsection{Intel VT-d}
Virtualization Technology for Directed I/O (VT-d\index{VT-d}) provides hardware
support for I/O-device virtualization. While VT-x provides the support to
virtualize the platform (i.e. the processor), VT-d is used to simplify the
secure assignment and virtualization of devices by providing direct memory
access (DMA\index{DMA}) and device interrupt remapping functionality
(IOMMU\index{IOMMU}).

VT-d is outside the scope of this master thesis, the reader is directed to
\cite{IntelVTd} for a more in-depth discussion of VT-d.
