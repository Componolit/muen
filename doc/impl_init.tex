\subsection{Init}\label{subsec:init}
After reset of a x86 system, the processor begins executing code at physical
address \texttt{ffff:0000}, which is mapped to the PC
BIOS\index{BIOS}\footnote{Basic Input/Output System}. The BIOS first performs
tests and initialization routines and then searches for a bootable storage
media. If found, the BIOS copies the first sector of the storage media to
physical address \texttt{0000:7C00} and jumps to this address (i.e. starts
executing code at this address). This is where the system bootloader comes to
live which is responsible to boot operating systems according to its
configuration. Many bootloaders first load additional code from the storage
media and then prepare the environment for OS execution.

The Muen seperation kernel is compliant to the multiboot specification, version
0.6.96 \cite{multiboot}. The multiboot standard is used to uniformly boot
different operating system kernels by multiboot-aware bootloaders.
The Muen kernel exports the required multiboot header within the first 8192
bytes of the OS image. The bootloader loads the OS image into memory according
to the information found in the header and jumps to the physical kernel entry
point specified in this header.

\begin{figure}[h]
	\centering
	\input{graph_init_mem_layout_example}
	\caption{Memory layout on system init (example)}
	\label{fig:init-mem-layout-example}
\end{figure}

Figure \ref{fig:init-mem-layout-example} shows the physical memory layout of an
example system. The kernel entry point of this system is at physical address
\texttt{0x00100000}. The main kernel uses the memory region starting from this
address to pysical address \texttt{0x00203fff} for code and data.

Low-memory (the physical memory below 1 MB) is used for system data structures
(colored in red). The AP\index{AP} trampoline\index{trampoline} is needed to
bootstrap the system's application processors as described in section
\ref{subsec:mp-support}. It initially resides in the kernel's text section and
must be copied to low-memory by the init code (see below).

To enable VMX operation using the \texttt{VMXON} instruction, one page per
logical CPU is required. This region is called VMXON\index{VMXON} region. Each
subject is managed using a VMCS\index{VMCS} data structure, so this memory is
placed in low-memory as well.

It is the bootloader's task to prepare the system state as demanded by the
multiboot standard, see \cite{multiboot} section 3.2 for details. The system
kernel can except the system to be in this exact state. After the Muen kernel
comes to live, it performs additional steps before jumping into the main SPARK
kernel.  This initial startup code is written in Assembly and conducts the
following tasks:
\begin{enumerate}
	\item Copy the AP trampoline to low-memory, see section
		\ref{subsec:mp-support} \item Initialize per-CPU VMXON regions
	\item Initialize subject VMCS regions
	\item Enable PAE\index{PAE}\footnote{Physical Address Extension}
	\item Initialize per-CPU kernel pagetables
	\item Enable IA-32e mode and execute-disable (NX)
	\item Enable paging, write protection, caching and native FPU error
		reporting
	\item Set up 64-bit GDT\index{GDT}\footnote{Global Descriptor Table}
	\item Set up Page-Attribute Table (PAT)
	\item Set up kernel stack
	\item Initialize Ada runtime
	\item Jump into kernel main
\end{enumerate}

The system is now in 64-bit IA-32e mode and each kernel calls the \texttt{VMXON}
VT-x instruction to enter VMX root operation.
